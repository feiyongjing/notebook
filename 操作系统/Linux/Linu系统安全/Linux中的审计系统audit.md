# 什么是audit？
- linux audit子系统是一个用于收集记录系统、内核、用户进程发生的行为事件的一种安全审计系统。该系统可以可靠地收集有关上任何与安全相关（或与安全无关）事件的信息，它可以帮助跟踪在系统上执行过的一些操作。
- linux审计系统可以通过提供系统上事件详细信息，来提高系统的安全性。但是它并不能像selinux那样为系统提供额外的安全性包含措施。审核仅需要为user提供系统上发生的event细节，user根据这些信息追踪event并采取相应的其他安全措施。
- audit和syslog有本质区别。syslog记录的信息有限，主要目的是软件调试，对于用户的操作行为（如某用户修改删除了某文件）却无法通过这些日志文件来查看。而audit的目的则不同，它是linux安全体系的重要组成部分，是一种“被动”的防御体系。
- 在内核里有内核审计模块，记录系统中的各种动作和事件，比如系统调用，文件修改，执行的程序，系统登入登出和记录所有系统中所有的事件，它的主要目的是方便管理员根据日记审计系统是否允许有异常，是否有入侵等等，说穿了就是把和系统安全有关的事件记录下来。

# audit有什么用？
- 查看文件访问
- 监控系统调用
- 记录用户指令的cmd指令
- 记录系统安全事件（如入侵行为）
- 监控网络访问

# 如何安装开启audit？
1. 首先内核需要打开 CONFIG_AUDIT 、CONFIG_AUDITSYSCAL配置
2. audit功能默认是关闭的，可以通过cmdline中加上“audit= 1”开启审计日志会被写到/var/log/messages中（auditd守护进程没有运行时）
3. 用户空间配置使用audit，首先需要安装audit并配置：
    - 安装：sudo yum install audit*.* -y
    - 开启audit服务（守护进程auditd）：service auditd start
    - 查看是否开启：service auditd status 或者是 auditctl -s ,开启了autid服务后，所有的审计日志会记录在/var/log/audit/audit.log文件中。

# 配置audit
### audit 安装后会生成 2 个配置文件
     - /etc/audit/auditd.conf 是守护程序的默认配置文件
     - /etc/audit/audit.rules 是记录审计规则的文件

### /etc/audit/auditd.conf 守护程序的默认配置文件详情
~~~shell
vim /etc/audit/auditd.conf

#
# This file controls the configuration of the audit daemon
#
local_events = yes                     # 启用本地事件审计
write_logs = yes                       # 允许将审计消息写入日志文件
log_file = /var/log/audit/audit.log    # 指定审计日志文件的路径
log_group = root                       # 设置日志文件的属组为 root
log_format = RAW                       # 设置日志的格式为 RAW，这是一种未解析的格式，可以直接由 auditd 读取
flush = INCREMENTAL_ASYNC              # 设置日志刷新方式为异步增量刷新
freq = 50                              # 设置异步刷新的频率，即每 50 个事件刷新一次日志
max_log_file = 8                       # 设置最大日志文件大小为 8 MB
num_logs = 5                           # 设置保留的日志文件数量为 5
priority_boost = 4                     # 为 auditd 进程的 nice 值提供 4 的提升
disp_qos = lossy                       # 设置审计消息的传输质量为“有损”，意味着在系统负载高时可能会丢失一些消息
dispatcher = /sbin/audispd             # 指定审计事件的分发器为 audispd
name_format = NONE                     # 不设置命名格式
##name = mydomain
max_log_file_action = ROTATE           # 当日志文件达到最大大小时，执行日志轮转
space_left = 75                        # 设置磁盘空间剩余百分比为 75% 时采取行动
space_left_action = SYSLOG             # 当磁盘空间剩余低于 75% 时，向系统日志发送警告
verify_email = yes                     # 验证发送警告的电子邮件地址
action_mail_acct = root                # 设置发送警告的电子邮件地址为 root
admin_space_left = 50                  # 设置磁盘空间剩余百分比为 50% 时采取管理行动
admin_space_left_action = SUSPEND      # 当磁盘空间剩余低于 50% 时，暂停审计
disk_full_action = SUSPEND             # 当磁盘满时，暂停审计
disk_error_action = SUSPEND            # 当磁盘错误时，暂停审计
use_libwrap = yes                      # 启用 TCP wrappers 库来限制对审计事件的远程访问
##tcp_listen_port = 60
tcp_listen_queue = 5                   # 设置 TCP 监听队列的长度为 5
tcp_max_per_addr = 1                   # 每个客户端地址的最大连接数为 1
##tcp_client_ports = 1024-65535
tcp_client_max_idle = 0                # 设置 TCP 客户端最大空闲时间为 0，即不限制
enable_krb5 = no                       # 禁用 Kerberos 5 认证
krb5_principal = auditd                # 设置 Kerberos 5 的主体名为 auditd
##krb5_key_file = /etc/audit/audit.key
distribute_network = no                # 禁用审计事件的网络分发
~~~
---

### /etc/audit/audit.rules 配置audit自定义对指定的文件或命令进行审计
- 如监视rm命令被执行、/etc/passwd文件内容被改变，只要配置好对应规则即可，配置规则可以通过命令行（auditctl 临时生效）或者编辑配置文件/etc/audit/audit.rules永久生效
- 注意编辑配置文件方式需要重新启动auditd服务 sudo systemctl restart auditd 配置才生效
  - 注意有些环境（centos7）下无法重启，请先 chmod 755 /var/log/audit/ 再 service auditd restart
~~~shell
vim /etc/audit/auditd.rules
# 配置文件其实就是把auditctl的命令直接拿过来即可，auditctl里支持的选项都可以在这个文件里指定，所以可以使用 man audit.rules 查看帮助手册
## This file is automatically generated from /etc/audit/rules.d
-D                         # 这是一个命令行选项，用于删除所有的审计规则。当你想要重新开始，只应用新的规则时，这个选项很有用。
-b 8192                    # 这个选项设置 auditd 使用的缓冲区大小为 8192，单位是字节。增加缓冲区大小可以帮助系统在处理大量审计事件时减少丢失事件的可能性
--backlog_wait_time 60000  # 这个选项设置在处理积压的事件时，auditd 最多等待的时间为 60000 毫秒（即 60 秒）。如果在指定的时间内无法处理所有积压的事件，超时的事件可能会被丢弃。
-f 1                       # 设置 auditd 的失败模式为 1，即当 auditd 无法写入审计日志时，错误信息将被发送到系统日志（syslog）
-w /home/test/aaa.txt -p r -k key_aaa  # -w指定监控的文件，-p 参数设置文件监控属性 r(读)、w（写）、x（执行）、a（修改文件系统属性），-k 参数设置key-name标志最终监控生成的日志在/var/log/audit/audit.log 中的会出现，以便于查找相应的监控日志
~~~
---

# 常用audit命令
~~~shell
# 设置临时对指定的文件设置审计规则，注意需要重新启动auditd服务审计规则就会丢失
auditctl -w /home/test/aaa.txt -p r -k key_aaa
# -w 参数指定监控的文件
# -p 参数设置文件监控属性 r(读)、w（写）、x（执行）、a（修改文件系统属性）
# -k 参数设置key-name标志最终监控生成的日志在/var/log/audit/audit.log 中的会出现，以便于查找相应的监控日志
# -l 参数查看设置的审计规则

# 直接用cat等查看/var/log/audit/audit.log 审计日志不太友好，ausearch 是查询audit log工具
ausearch [参数]
# -f 参数指定监控的文件名称，在/var/log/audit/下的所有audit日志文件中搜索指定监控文件的审计日志
# -k 参数指定key-name标志，在/var/log/audit/下的所有audit日志文件中搜索指定key-name标志的审计日志

# aureport 输出audit系统报告
aureport [参数]
# -au 参数查看关于鉴权相关的信息，sshd 登录的记录，有登录时间、登录用户、来源ip、是否登录成功
# -m 参数查看关于用户修改相关的信息，例如 passwd 修改用户密码、useradd添加用户等的记录
~~~
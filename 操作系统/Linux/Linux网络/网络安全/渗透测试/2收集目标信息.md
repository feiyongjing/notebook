
# 第一步：渗透测试收集信息
## 收集那些信息
- 服务器信息：真实IP、端口、端口提供的服务
- 网站信息：网站架构（操作系统、中间件、数据库、编程语言）、指纹信息、WAF、敏感目录、敏感文件、源码泄露、旁站查询、C段查询
- 域名信息：whois、备案信息、子域名
- 人员信息：姓名、职务、头像照片、年龄、生日、联系电话、邮件地址、个人特定意义字符串

## 收集信息使用的工具和方法
- 踩点 footprinting
  - web搜索和挖掘
  - DNS和IP查询
  - 网络拓扑侦察
- 扫描 scanning
  - 主机扫描
  - 端口扫描
  - 系统类型探查
  - 漏洞扫描
- 查点 enumberating
  - Flag抓取
  - 网络服务查点

## 域名信息收集
~~~shell
# whois 查询域名是否以及注册，以及域名的注册人、注册商、DNS域名解析服务器等信息，2级域名以下子域名可能查询不到信息
# 一般情况下中小型网站域名注册者就是网站管理员
# 也可以使用别人搭建好的whois服务去查询，例如阿里云的whois查询服务：https://www.alibabacloud.com/zh/whois/home?_p_lc=1
# 先通过whois获取注册人和邮箱，然后再通过其他方式根据注册人和邮箱反查有没有注册更多的网站域名（缺点：很多公司的域名都是DNS解析的注册商注册的，查到的是运营商代替个人和公司注册的网站信息）
whois baidu.com

# ssl证书信息收集（也可以用于收集子域名信息）：https://crt.sh/ 搜索域名可以看到这个域名和子域名的相关ssl证书信息（包含历史证书），例如baidu.com

# 子域名收集
# 方式一：浏览器搜索 site:域名 搜索信息，确定域名真时存在并且提供服务，如果是顶级域名是可以找到更多的子域名的
# 方式二：有些网站提供这样的服务，例如在 https://fofa.info/  中搜索domain="baidu.com"可以找到更多的子域名信息
# 方式三：下载 https://github.com/Threezh1/JSFinder python脚本（需要python2），运行该脚本抓取网页上的子域名
# 方式四：下载 https://github.com/lijiejie/subDomainsBrute 项目配置一下，运行脚本爆破获取子域名
# 方式五：下载 https://github.com/shmilylty/OneForAll 项目配置一下，运行脚本爆破获取子域名

# 方式四使用如下
# 1、下载项目(如果命令行没有设置代理需要浏览器手动下载)
git clone https://github.com/lijiejie/subDomainsBrute

# 2、安装依赖
pip install dnspython==2.2.1 async_timeout

# 3、开始收集子域名信息
python subDomainsBrute.py example.com 
# 正常执行完毕会在当前目录下出现 域名.txt文件，例如：example.com.txt


# 方式五使用如下
# 1、下载项目(如果命令行没有设置代理需要浏览器手动下载)
git clone https://github.com/shmilylty/OneForAll.git

# 2、安装依赖
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/

# 3、查看帮助
python oneforall.py --help

# 4、开始收集子域名信息
# 可以提前查看config目录下的api.py、default.py、setting.py中的相关配置，一般情况下默认的配置就足够使用了
python oneforall.py --target example.com run
# 正常执行完毕会在results目录生成相应结果
# example.com.csv是每个主域下的子域收集结果。
# all_subdomain_result_1583034493.csv是每次运行OneForAll收集到子域的汇总结果，包含example.com.csv，方便在批量收集场景中获取全部结果。
# result.sqlite3是存放每次运行OneForAll收集到子域的SQLite3结果数据库
~~~

## IP信息收集
如果渗透目标为虚拟主机，那么通过IP反查到的域名信息很有价值，因为一台物理服务器上面可能运行多个虚拟主机。这些虚拟主机有不同的域名，但通常共用一个IP地址。如果你知道有哪些网站共用这台服务器，就有可能通过此台服务器上其他网站的漏洞获取服务器控制权，进而迂回获取渗透目标的权限，这种技术也称为“旁注“
~~~shell
# dnsenum 收集域名使用的IP地址、DNS地址信息
# nslookup 收集域名使用的IP地址，会将域名对应的多个IP都列出来
dnsenum --enum baidu.com
nslookup baidu.com

# traceroute 查询发送到指定域名的数据包中间经过的线路信息，但是目前大部分的线路节点都做了屏蔽，是无法查看到信息的
traceroute baidu.com

# 判断目标主机是否存活以及查看ip地址，注意可能获取到的是cdn地址，而通过多个地区都ping获取的IP如果都是同一个IP地址那这个IP地址就可能是真实IP地址
ping baidu.com

# 如果网站有phpinfo文件可以下载下来，其中的server_addr是网站的真实IP（获取到php搭建的网站同时暴露phpinfo文件可能性比较小）
~~~

## 端口信息收集和漏洞检测
- 系统端口：一般是0到1023
- 注册端口：1024到49152分配给用户进程和程序
- 动态端口：49152到65535不固定分配给某种服务  

nmap扫描端口信息收集流程
1. 检测网络存活主机(主机发现)
2. 检测主机开放端口(端口发现或枚举)
3. 检测相应端口软件(服务发现)版本
4. 检测操作系统，硬件地址，以及软件版本
5. 检测脆弱性的漏洞(nmap的脚本)
~~~shell
# nmap 端口扫描，参考：https://blog.csdn.net/Xxy605/article/details/107620999
nmap [-sS] [-v] [-Pn] [-T4] [服务器IP或域名或网段] [-p 80,443 或 1-40000] [-sV]
# -sS 参数: 执行TCP SYN扫描，这是Nmap默认的扫描方式，通常被称为半开放扫描。一个完整的tcp连接需要3次握手，而-sS选项不需要，它不打开一个完全的TCP连接，执行得很快，效率高，Nmap发送SYN包到远程主机，但是它不会产生任何会话，目标主机几乎不会把连接记入系统日志。(防止对方判断为扫描攻击)
# -Pn 参数: 扫描之前不需要用ping命令，有些防火墙禁止ping命令。可以使用此选项进行扫描
# -sT 参数：使用 tcp 扫描，
# -T0(偏执的):非常慢的扫描,用于IDS逃避
# -T1(鬼崇的):缓慢的扫描,用于IDS逃避
# -T2(文雅的):降低速度以降低对带宽的消耗,此选项一般不常用
# -T3(普通的):默认根据目标的反应自动调整时间
# -T4(野蛮的):快速扫描,常用扫描方式,需要在很好的网络环境下进行扫描,请求可能会淹没目标
# -T5(疯狂的):急速扫描,这种扫描方式以牺牲准确度来提升扫描速度,
# -sU 参数：使用 udp 扫描
# -sP 参数：使用 ICMP 扫描，即ping，一般在全端口扫描是不使用这个选项的，因为非常慢
# -p 参数指定扫描端口或者是端口扫描范围，默认不加只扫描1到1024端口
# -sV 参数探测主机的开放端口以确定该端口的服务和版本信息
# -O 参数尝试识别目标主机的操作系统，需要root权限才能启用
# -A 参数: 启用操作系统检测、版本检测、脚本扫描和跟踪路由，需要root权限才能启用
# -sN 参数：TCP空扫描欺骗防火墙
# --traceroute 参数：进行路由跟踪
# -v 参数: 提高输出信息的详细程度（可以使用多个v来增加详细程度）
# -iL 参数：扫描指定文件中的IP地址列表 nmap -iL target.txt
# --exclude 参数：排除指定目标ip的扫描，例如：扫描除指定IP外的所有子网主机 nmap 192.168.1.1/24 --exclude 192.168.1.1
# --excludefile 参数：扫描除文件中IP列表外的子网主机:nmap 192.168.1.1/24 --excludefile xxx.txt
# -oG 参数：扫描的结果导出，每行文本，字段分隔清晰，案例：nmap -sS -v -Pn -T4 -oG test.gnmap 192.168.0.1 -p 80,443 -sV
# -oN 参数：扫描的结果导出，普通文本，人类易读的详细报告，案例：nmap -sS -v -Pn -T4 -oN test.gnmap 192.168.0.1 -p 80,443 -sV

# --script 参数：通过运行预定义或自定义脚本，可以扩展 Nmap 的功能，实现端口扫描之外的高级任务（如漏洞检测、服务识别、安全审计等），NSE 脚本存储在 Nmap 安装目录的 scripts/ 文件夹中（通常路径为 /usr/share/nmap/scripts/），NSE 脚本会定期更新，建议用 nmap --script-updatedb 更新脚本数据库，确保使用最新脚本，另外有 --script-help 参数查看脚本的帮助文档（包括功能、参数说明），例如：nmap --script-help heartbleed  查看 heartbleed 脚本的用法
# 案例一：运行单个脚本直接指定脚本文件名（无需扩展名 .nse），检测目标是否存在 Heartbleed 漏洞（CVE-2014-0160）：nmap --script heartbleed 192.168.1.1
# 案例二：运行多个脚本 ssh-brute（SSH 暴力破解）和 ssh-auth-methods（SSH 认证方法探测）：nmap --script ssh-brute,ssh-auth-methods 192.168.1.100
# 案例三：部分脚本需要额外参数（如暴力破解的用户名 / 密码字典），可以用 --script-args 指定，例如对 SSH 服务进行暴力破解，指定用户名字典和密码字典：nmap --script ssh-brute --script-args userdb=users.txt,passdb=passwords.txt 192.168.1.100
# 案例四：枚举目标域名的子域名和 DNS 记录：nmap --script dns-brute --script-args dns-brute.domain=example.com example.com
# 案例五：检测 MySQL 服务的弱口令：nmap --script mysql-brute 192.168.1.1 -p 3306
# 案例六：探测 HTTP 服务的详细信息（如服务器类型、robots.txt、目录枚举）：nmap --script http-enum,http-server-header 192.168.1.1 -p 80
# 案例七：运行所有以 http 开头的脚本：nmap --script "http-*" 192.168.1.100 -p 80,443
# 案例八：NSE 脚本按功能分为多个类别，可以指定运行某个类别下的所有脚本，运行所有漏洞检测脚本（vuln 类别）：nmap --script vuln 192.168.1.1
# 常见类别及用途：
# vuln：检测已知漏洞（如 Heartbleed、MS17-010 等）
# auth：处理认证相关任务（如暴力破解、认证方法探测）
# discovery：发现网络信息（如 DNS 枚举、SNMP 扫描）
# safe：安全脚本（不影响目标系统，适合初步扫描）
# intrusive：可能对目标产生影响的脚本（如暴力破解、DOS 测试，谨慎使用）

# Open             端口开启，数据有到达主机，有程序在端口上监控
# Closed           端口关闭，数据有到达主机，没有程序在端口上监控
# Filtered         数据没有到达主机，返回的结果为空，数据被防火墙或IDS过滤
# UnFiltered       数据有到达主机，但是不能识别端口的当前状态
# OpenFiltered     端口没有返回值，主要发生在UDP、IP、FIN、NULL和Xmas扫描中
# Closed|Filtered  只发生在IP ID idle扫描
~~~

### FTP文件传输服务渗透：一般使用TCP端口20、21，20用于传输数据，21用于传输控制信息
1. ftp基础爆破:cwasp的Bruter,hydra以及msf中的ftp爆破模块
2. ftp匿名访问:用户名:anonymous 密码:为空或者任意邮箱
3. vsftpd后门:vsftpd 2到2.3.4版本存在后门漏洞，通过该漏洞获取root权限
4. 嗅探:ftp使用明文传输，使用Cain进行渗透。(但是探需要在局域网并需要欺骗或监听网关)
5. ftp远程代码溢出
6. ftp跳转攻击

### SSH服务:(secure shell)是目前较可靠，专为远程登录会话和其他网络服务提供安全性的协议
1. 弱口令，可使用工具hydra，msf中的ssh爆破模块
2. SSH后门
3. openssh 用户枚举 CVE-2018-15473

### Telnet协议是TCP/IP协议族中的一员，是Internet远程登录服务的标准协议和主要方式
1. 暴力破解，使用hydra,或者msf中teInet模块对其进行破解。
2. 在linux系统中一般采用SSH进行远程访问，传输的敏感数据都是经过加密的而对于windows下的telnet来说是脆弱的，因为默认没有经过任何加密就在网络中进行传输。使用cain等嗅探工具可轻松截获远程登录密码。

### smtp:邮件协议，在linux中默认开启这个服务，可发送钓鱼邮件，默认端口:25(smtp)、465(smtps)
1. 爆破:弱口令，使用hydra
2. SMTP 无认证伪造发件人

### http: 超文本传输协议(HTTP)开放的端口80，主要用于万维网传输信息的协议
1. 中间件漏洞，如IIS、apache、nginx等
2. 80端口一般通过web应用程序的常见漏洞进行攻击

### Tomcat服务默认端口8080
1. Tomcat远程代码执行漏洞(CVE-2019-0232)
2. Tomcat任意文件上传(CVE-2017-12615)
3. Tomcat管理页面弱口令getshell

### NetBl0S SessionService使用139和445端口：139用于提供windows文件和打印机共享及UNIX中的Samba服务，445用于提供windows文件和打印机共享
1. 对于开放139/445端口，尝试利用MS17010溢出漏洞进行攻击
2. 对于只开放445端口，尝试利用MS06040、MS08067溢出漏洞攻击
3. 利用IPC$连接进行渗透

### MYSQL数据库服务默认的监听端口3306
1. mysql弱口令破解
2. 弱口令登录mysql，上传构造的恶意UDF自定义函数代码，通过调用注册的恶意函数执行系统命令
3. SQL注入获取数据库敏感信息，load file()函数读取系统文件，导出恶意代码到指定路径

### windows远程桌面服务RDP默认监听的端口3389
1. RDP暴力破解攻击
2. MS12 020死亡蓝屏攻击
3. RDP远程桌面漏洞(CVE-2019-0708)
4. MSF开启RDP、注册表开启RDP

### 开源的可基于内存的可持久化的日志型数据库Redis的默认端口6379
1. 爆破弱口令
2. redis未授权访问结合ssh key提权
3. 主从复制rce

### weblogic服务默认端口7001
1. 弱口令、爆破，弱密码一般为weblogic/Oracle@123 or weblogic
2. 管理后台部署 war包后门
3. weblogic SSRF
4. 反序列化漏洞

## 指纹信息收集

### 网站指纹识别
~~~shell
# 确认目标的操作系统，也可以直接使用ping 命令，一般Windows的ttl是100以上，linux是100以下
# 如果有网站URL，可以修改域名外的路径字母大小写，一般linux对大小写敏感无法访问，而windows对大小写不敏感可以切换路径中字母的大小写进行访问
nmap -O -Pn -T4 -A 127.0.0.1

# cms系统称为内容管理系统，用于网站内容文章管理，例如博客、新闻等，一般这些使用开源CMS搭建的网站都有比较多的漏洞，现在流行的开源CMS系统有WordPress、Joomla!、Drupal、Xoops、CmsTop、大汉CMS、织梦、帝国CMS、phpcms、ecshop等
# cms系统识别方式一：Wappalyzer可以识别网站上的技术，包括内容管理系统，电子商务平台，JavaScript框架，分析工具，打包工具等等。可以在谷歌商店直接下载扩展程序，使用很方便。
# cms系统识别方式二：通过 https://developer.aliyun.com/article/1616236 的案例代码调用云悉Web指纹API识别网站的CMS类型、服务器信息、JavaScript库等
# cms系统识别方式三：WhatWeb地址：https://github.com/urbanadventurer/WhatWeb 此工具kali自带，使用方法：
whatweb www.example.com 
# 也可以加参数-v显示更详细的信息。

# 指纹信息收集，p0f是被动的指纹收集工具，用于收集链接当前机器的设备操作系统信息，即使是在系统上装有性能良好的防火墙的情况下也没有问题
sudo p0f [参数]
# 网络接口参数:
#   -i iface  - 指定监听的网络接口
#   -r file   - 读取由抓包工具抓到的网络数据包文件，即 .pcap 文件
#   -p        - 设置 -i参数 指定的网卡 为混杂模式
#   -L        - 列出所有可用接口
# 操作模式和输出设置参数:
#   -f file   - 指定指纹数据库 (p0f.fp) 路径，不指定则使用默认数据库。(默认：/etc/p0f/p0f.fp)
#   -o file   - 将信息写入指定的日志文件中。只有同一网卡的log文件才可以附加合并到本次监听中来。
#   -s name   - 回答 unix socket 的查询 API
#   -u user   - 以指定用户身份运行程序，工作目录会切换到到当前用户根目录下；
#   -d        - 以后台进程方式运行p0f (requires -o or -s)
# 性能相关的选项参数:
#   -S limit  - 设置API并发数，默认为20，上限为100；
#   -t c,h    - 设置连接超时时间 (30s,120m)
#   -m c,h    - 设置最大网络连接数(connect)和同时追踪的主机数(host)(默认值: c = 1,000, h = 10,000).
~~~

### 网站敏感文件和目录扫描
常见敏感目录和文件
- github、.git、svn：
- .hg：.hg文件是Mercurial（Hg）版本控制系统使用的文件格式，主要用于管理软件源代码或其他文件集的变更历史。它们通常包含版本控制信息和项目的历史记录。
- .bzr：.bzr文件是Bazaar（bzr）版本控制系统的核心组成部分。Bazaar用于管理源代码和项目文件的版本，允许用户跟踪更改、协作开发和管理项目历史记录。在使用Bazaar初始化项目时，系统会在项目根目录下创建一个名为.bzr的隐藏目录。这个目录包含了与版本控制相关的所有信息，包括源代码的快照和用户信息。
- .DS_Store：mac OS系统中的存储这个文件夹的显示属性的：比如文件图标的摆放位置，通过 .DS_Store 可以知道这个目录里面所有文件的清单
- WEB-INF：WEB-INF是Java Web应用程序的核心安全目录，该目录包含web.xml部署描述文件，负责配置Servlet、过滤器等组件。classes文件夹存储编译后的.class文件，lib目录存放项目依赖的JAR包，src目录保存Java源代码。此外还包含数据库配置文件、自定义标签库（tags目录）以及区分JSP版本的jsp/jsp2目录，形成了完整的应用资源配置体系。META-INF子目录则承载JAR包元数据信息
~~~shell
# GitHack是一个.git泄露利用脚本，通过泄露的.git文件夹下的文件，解析.git/index文件，找到工程中所有的： ( 文件名，文件sha1 )，去.git/objects/ 文件夹下下载对应的文件，zlib解压文件，按原始的目录结构写入源代码
# 渗透测试人员、攻击者，可以进一步审计代码，挖掘：文件上传，SQL注射等web安全漏洞。
# 源码库：https://github.com/lijiejie/GitHack
# 下载源码直接运行脚本
python GitHack.py http://www.openssl.org/.git/


# Dirsearch 是一个用于探测Web服务器上的隐藏目录和文件的工具。它通过发送HTTP请求来尝试访问可能存在的路径，从而找到不列在网站目录页面上的隐藏资源。
# Dirsearch 的主要特点包括：
# 1.多线程：Dirsearch 采用多线程方式进行目录扫描，充分利用系统资源提高扫描效率。
# 2.字典支持：它支持使用自定义字典文件来进行目录爆破，你可以使用自己的字典文件或使用内置的常用字典。（注：字典必须是文本文件）
# 3.支持多种形式的网页（asp，php）
# 4.支持HTTP代理
# 5.启发式检测无效的网页
# 6.指定扩展名：你可以选择限制扫描的文件扩展名范围，以便更加精确地进行目录扫描。
# 7.进度追踪：Dirsearch 提供实时进度追踪，你可以看到当前扫描的进度和已发现的目录和文件。
# 8.结果输出：完成扫描后，Dirsearch 会生成详细的扫描报告（纯文本，JSON），展示已发现的隐藏目录和文件。
# 源码库：https://github.com/maurosoria/dirsearch
# 使用参考：https://developer.aliyun.com/article/1395854
# 下载源码后进入项目安装依赖
pip install --upgrader -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple
# dirsearch帮助
python dirsearch.py -h
# -u 参数：指定目标URL进行扫描，可以使用多个选项指定多个目标URL
# -e 参数：扫描的文件扩展名列表，以逗号分隔（例如：php,asp）
# -w 参数：单词列表文件或包含单词列表文件的目录（以逗号分隔）
# -r 参数：递归地进行扫描
# -t 参数：设置线程数
# -i 参数：包括的状态码，以逗号分隔，支持范围（例如：200,300-399）
# -x 参数：排除的状态码，以逗号分隔，支持范围（例如：301,500-599）
# -o 参数：设置扫描结果输出到文件
# -m 参数：HTTP请求方法设置（默认为GET）
# -H 参数：HTTP请求标头设置，可以使用多个标志
# -p 参数：设置请求使用的代理URL（HTTP/SOCKS），可以使用多个标志
# --user-agent 参数：设置HTTP请求User-Agent
# --cookie 参数：设置HTTP请求cookie

# 案例1：对 http://example.com 进行目录扫描，使用自定义的单词列表文件 custom-wordlist.txt，并启用深度递归扫描，即在每个目录的所有深度上执行递归扫描。
python dirsearch.py -u http://example.com -w custom-wordlist.txt -r --deep-recursive
# 案例2：对 http://example.com 进行目录扫描，使用最多 10 个线程并仅检查扩展名为 php 和 asp 的路径，同时排除扩展名为 html 的路径
python dirsearch.py -u http://example.com -t 10 -e php,asp --exclude-extensions=html
# 案例3：从 urls.txt 文件中读取目标URL列表，并使用最多 5 个线程对每个URL进行目录扫描，仅检查扩展名为 php 的路径
python dirsearch.py -l urls.txt -t 5 -e php
# 案例4：对 http://example.com 进行目录扫描，并在每个请求中包含自定义的HTTP头和自定义的User-Agent头
python dirsearch.py -u http://example.com -H "X-Custom-Header: Value" -H "Authorization: Bearer toke" --user-agent "Custom User Agent"  
# 案例5：只包含状态码为200和302的响应，并排除状态码为404和500的响应
python dirsearch.py -u http://example.com -i 200,302 -x 404,500
# 案例6：将扫描结果输出到指定的文件 output.txt
python dirsearch.py -u http://example.com -o output.txt
# 案例7：通过指定的HTTP代理（例如Burp Suite）对目标URL进行扫描
python dirsearch.py -u http://example.com -p http://proxy1:8080 -p http://proxy2:8080



# dirmap是一个高级web目录扫描工具，功能将会强于DirBuster、Dirsearch、cansina、御剑
# 源码库：https://github.com/H4ckForJob/dirmap
# 下载源码后进入项目安装依赖
pip install -r requirement.txt
# 查看帮助
python dirmap.py 

# 单目标、子网、指定范围、指定多目标扫描（不加协议默认是http，targets.txt中支持上述子网、指定范围格式）
python dirmap.py -i https://target.com -lcf
python dirmap.py -i 192.168.1.0/24 -lcf
python dirmap.py -i 192.168.1.1-192.168.1.100 -lcf
python dirmap.py -iF urls.txt -lcf

~~~

### 网站WAF识别
waf的功能
1. 防止常见的各类网络攻击，如:SQL注入、XSS跨站、CSRF、网页后门等;
2. 防止各类自动化攻击，如:暴力破解、撞库、批量注册、自动发贴等;
3. 阻止其它常见威胁，如:爬虫、0 DAY攻击、代码分析、嗅探、数据篡改、越权访问、敏感信息泄漏、应用层DDOS、远程恶意包含、盗链、越权、扫描等。
~~~shell
# 源码
https://github.com/EnableSecurity/wafw00f

# 安装方式一：无须下载源码，直接使用pip安装
pip install wafw00f

# 安装方式二：下载源码进入项目目录下安装依赖（注意请使用虚拟环境，有可能破坏系统包）
python -m pip install .

# 查看可以识别到哪些类型的的WAF
wafw00f -l

# 使用wafw00f识别网站的WAF信息
wafw00f https://example.org

# namp也可以识别WAF，不过效果没有wafw00f好
nmap -p80,443 --script http-waf-detect ip
nmap -p80,443 --script http-waf-fingerprint ip
~~~



